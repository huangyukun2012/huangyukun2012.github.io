<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="google7f229cdbee7c0ea2.html" />










  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="stepfurther">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="stepfurther">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="stepfurther">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>

  <title> 
  Hexo, NexT - stepfurther -  
</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?94f545b0ee6872779f3f21be1f793ec1";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">stepfurther</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tools">
          <a href="/tools" rel="section">
            
              <i class="menu-item-icon fa fa-question-circle fa-fw"></i> <br />
            
            menu.tools
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/04/threadPool-and-taskQueue/" itemprop="url">
                  threadPool_and_taskQueue
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2017-05-04T14:31:50+08:00" content="2017-05-04">
              2017-05-04
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/05/04/threadPool-and-taskQueue/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/05/04/threadPool-and-taskQueue/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

		
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>摘要: 线程池与任务队列，是提高程序性能的重要方法。本文通过一个demo展示线程池与任务队列的实现，默认读者已经了解C++中的基本多线程技术：锁、互斥量、信号量.</p>
<h2 id="模型介绍"><a href="#模型介绍" class="headerlink" title="模型介绍"></a>模型介绍</h2><p>线程间通信是通过任务队列来实现的；线程通信对应的数据和任务都被封装成一个个任务，线程池按照先进先出的原则来处理处理任务队列中的任务。这里我们采用生产者/消费者模型(producer/consumer)。</p>
<p>实例: 生产者以一定的速度产生字符串，插入到任务队列中；消费者不断从任务队列中取出字符串，并将字符串都改成大写之后，然后返回.</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>首先我们来分析任务队列的实现,任务队列需要实现如下功能和特点：</p>
<ul>
<li>入队列(enqueue): 将新任务加入到队列头部.</li>
<li>出队列(dequeue): 从队列尾部取出一个任务; 由于任务队列是生产者和消费者（线程池）共享的；所以对任务队列的访问在不同的线程之间，需要串行执行; 这里，我们需要通过互斥锁来实现对队列的串行访问.</li>
<li>队列判空(empty)</li>
</ul>
<p>其中producer 一端有8个线程，consumer 有8个线程，持续处理任务队列中的任务. 整个工作流如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">producer:</div><div class="line">while(true)</div><div class="line">&#123;</div><div class="line">	Task *t=generate_task();</div><div class="line">	enqueue(t);</div><div class="line">	sleep(random_period);</div><div class="line">&#125;</div><div class="line"></div><div class="line">consumer:</div><div class="line">while(true)</div><div class="line">&#123;</div><div class="line">	if(!queue.empty())</div><div class="line">	&#123;</div><div class="line">		Task *t=nullptr;	</div><div class="line">		t= dequeue();</div><div class="line">		if (t != nullptr)</div><div class="line">			t-&gt;run()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>显然，上述简单的模型存在以下问题:</p>
<ol>
<li>即使任务队列为空，CPU的利用率依然会在100%，因为消费者会出现忙等待。为了解决这个问题，我们需要引入信号量来实现线程同步——任务队列为空的时候，阻塞消费者线程;当任务队列非空时，唤醒消费者线程.</li>
<li>当消费者线程处理缓慢的时候, 生产者进程会不断给任务队列增加新的任务，最终导致资源耗尽而死机;所以需要引入另外一个信号量，表示任务已满：当任务已满的时候，阻塞生产者线程；当不满时，唤醒生产者线程.</li>
</ol>
<p>同时，我们可以将互斥量的使用封装在函数内部(dequeue, enqueue), 这样，workflow 如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">consumer:</div><div class="line">    Task *task=nullptr;</div><div class="line">    while (task_queue_.dequeue(task) &gt;= 0)</div><div class="line">    &#123;</div><div class="line">		task-&gt;run();</div><div class="line">        task-&gt;destroy();</div><div class="line">    &#125;</div><div class="line">producer:</div><div class="line">	while(true)</div><div class="line">	&#123;</div><div class="line">		Task *task=nullptr;</div><div class="line">		generate_task(task);</div><div class="line">		task_queue_.enqueue(task);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">=========</div><div class="line">          int enqueue(T *t)</div><div class="line">          &#123;</div><div class="line">              mutex_.acquire();</div><div class="line">				//carefull:one thread may be blocked not only for this condition:not_full_cond_, so we use `while` instead of `if`.</div><div class="line">              while (count_ &gt;= capacity_)</div><div class="line">              &#123;</div><div class="line">                  not_full_cond_.wait();</div><div class="line">              &#125;</div><div class="line">              items_.push_back(t);</div><div class="line">              ++count_;</div><div class="line">              not_empty_cond_.signal();</div><div class="line">              mutex_.release();</div><div class="line">              return 0;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          int dequeue(T *&amp;t)</div><div class="line">          &#123;</div><div class="line">              mutex_.acquire();</div><div class="line">              while (items_.empty())</div><div class="line">              &#123;</div><div class="line">                  empty_cond_.signal();</div><div class="line">                  not_empty_cond_.wait();</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              &#123; t = items_.back(); items_.pop_back(); &#125;</div><div class="line">              --count_;</div><div class="line">              not_full_cond_.signal();</div><div class="line">              mutex_.release();</div><div class="line">              return 0;</div><div class="line">          &#125;</div></pre></td></tr></table></figure>
<p>详细的code可以参考这里()</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/04/octave/" itemprop="url">
                  Untitled
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2017-05-04T14:16:07+08:00" content="2017-05-04">
              2017-05-04
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/05/04/octave/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/05/04/octave/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

		
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>摘要: octave是一门很好的机器学习入门语言，本文主要介绍octave的一些基本语法：矩阵的创建、基本运算等。</p>
<h2 id="向量"><a href="#向量" class="headerlink" title="向量"></a>向量</h2><p><code>linspace (base, limit, n)</code><br>    Return a row vector with n linearly spaced elements between base and limit.<br>You can open multiple plot windows using the figure function. For example,</p>
<p><code>logspace (a, b, n)</code><br>Return a row vector with n elements logarithmically spaced from 10^a to 10^b.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">figure (1);</div><div class="line">fplot (@sin, [-10, 10]);</div><div class="line">figure (2);</div><div class="line">fplot (@cos, [-10, 10]);</div></pre></td></tr></table></figure>
<p><code>surf</code><br>: surf (x, y, z)<br>: surf (z)<br>: surf (…, c)<br>: surf (…, prop, val, …)<br>: surf (hax, …)<br>: h = surf (…)<br>Plot a 3-D surface mesh.</p>
<ul>
<li>plot  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">: plot (y)</div><div class="line">: plot (x, y)</div><div class="line">: plot (x, y, fmt)</div><div class="line">: plot (…, property, value, …)</div><div class="line">: plot (x1, y1, …, xn, yn)</div><div class="line">: plot (hax, …)</div><div class="line">: h = plot (…)</div></pre></td></tr></table></figure>
</li>
</ul>
<p>eg: <code>plot(theta(1), theta(2), &#39;rx&#39;, &#39;MarkerSize&#39;, 10, &#39;LineWidth&#39;, 2);</code></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/14/domain-name-resolution/" itemprop="url">
                  domain-name-resolution
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-14T09:13:08+08:00" content="2016-03-14">
              2016-03-14
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/14/domain-name-resolution/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/14/domain-name-resolution/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

		
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/10/ios-developing/" itemprop="url">
                  swift 语法介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-10T00:15:34+08:00" content="2016-03-10">
              2016-03-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/ios/" itemprop="url" rel="index">
                    <span itemprop="name">ios</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/10/ios-developing/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/10/ios-developing/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

		
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="swift-简介"><a href="#swift-简介" class="headerlink" title="swift 简介"></a>swift 简介</h2><p>swift 是ios上的官方开发语言。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/10/new-in-cpluplus/" itemprop="url">
                  C++ 中的new运算符
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-10T00:15:34+08:00" content="2016-03-10">
              2016-03-10
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/10/new-in-cpluplus/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/10/new-in-cpluplus/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

		
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><p>new是C++程序设计语言中的一种语言结构，用于动态分配内存、并用构造函数初始化分配的内存。</p>
<p>new的使用称为“new运算符表达式”，其内部实现分为两步：</p>
<ol>
<li><p><strong>调用相应的operator new()函数，动态分配内存。</strong>如果operator new()不能成功获得内存，则调用new_handler函数。如果没有设置new_handler函数或者new_handler未能分配足够内存，则抛出std::bad_alloc异常。“new运算符表达式”所调用的operator new()函数，按照C++的名字查找规则，首先做依赖于实参的名字查找（即ADL规则），在要申请内存的数据类型T的内部、数据类型T定义处的命名空间查找；如果没有查找到，则直接调用全局的::operator new()函数。</p>
</li>
<li><p><strong>在分配到的动态内存块上初始化相应类型的对象并返回其首地址。</strong>如果调用构造函数初始化对象时抛出异常，则自动调用operator delete()函数释放已经分配到的内存。</p>
</li>
</ol>
<ul>
<li><p>每个new获取的对象，必须用delete析构并释放内存，以免内存泄漏。</p>
</li>
<li><p>new运算符表达式是C++的一种语言结构，不可重载。但用户可重载operator new()函数。</p>
</li>
</ul>
<h2 id="2-new运算符表达式"><a href="#2-new运算符表达式" class="headerlink" title="2.new运算符表达式"></a>2.new运算符表达式</h2><h3 id="2-1-普通的new运算符"><a href="#2-1-普通的new运算符" class="headerlink" title="2.1 普通的new运算符"></a>2.1 普通的new运算符</h3><p>model：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">p = <span class="keyword">new</span> <span class="keyword">typename</span>;</div><div class="line">p = <span class="keyword">new</span> <span class="keyword">typename</span>(init);</div><div class="line">p = <span class="keyword">new</span> <span class="keyword">typename</span>&#123;init&#125;;</div><div class="line">``` </div><div class="line"></div><div class="line">eg：</div><div class="line"></div><div class="line">```c++</div><div class="line"><span class="keyword">int</span> *p = <span class="keyword">new</span> <span class="keyword">int</span>;</div><div class="line"><span class="keyword">int</span> *p = <span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">5</span>);</div><div class="line"><span class="keyword">int</span> *p = <span class="keyword">new</span> <span class="keyword">int</span>&#123;<span class="number">5</span>&#125;;<span class="comment">//C++ 11</span></div></pre></td></tr></table></figure>
<h3 id="2-2-生成对象数组的new运算符"><a href="#2-2-生成对象数组的new运算符" class="headerlink" title="2.2 生成对象数组的new运算符"></a>2.2 生成对象数组的new运算符</h3><p>model:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">p = <span class="keyword">new</span> type[size];</div><div class="line">p = <span class="keyword">new</span> type[size] &#123;one, two , size&#125;;</div></pre></td></tr></table></figure></p>
<p>eg:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">p = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">5</span>];</div><div class="line">p = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">5</span>]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</div></pre></td></tr></table></figure></p>
<h3 id="2-3-带位置的new运算符"><a href="#2-3-带位置的new运算符" class="headerlink" title="2.3 带位置的new运算符"></a>2.3 带位置的new运算符</h3><p>model:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> ( expression-<span class="built_in">list</span> ) type ( init);</div></pre></td></tr></table></figure></p>
<p>expression-list将作为<code>operator new()</code>函数的实参列表的结尾部分。这种形式的new运算符表达式首先调用<code>operator new(size_t,OtherTypeList)</code>函数来获取内存；然后对该对象执行构造函数。这里的OtherTypeList作为形参列表要和new括号里的实参列表expression-list的类型兼容（即形参实参能够匹配）。</p>
<p>带位置的new运算符，语义上包括四种使用情形：</p>
<ol>
<li>直接给出要构建的对象的内存位置；</li>
<li>不抛出异常，如果内存分配失败返回空指针；</li>
<li>定制的、带其他参数的内存分配器；</li>
<li>用于调试目的，在构造函数调用失败时给出源文件名与行号。</li>
</ol>
<p>狭义上的带位置的new是指第一种情形。使用这种placement new，<strong>原因之一</strong>是用户的程序不能在一块内存上自行调用其构造函数（即用户的程序不能显式调用构造函数），必须由编译系统生成的代码调用构造函数。<strong>原因之二</strong>是可能需要把对象放在特定硬件的内存地址上，或者放在多处理器内核的共享的内存地址上。</p>
<p>释放这种对象时，不能调用placement delete，应直接调用析构函数，如：pObj-&gt;~ClassType();然后再自行释放内存。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt; </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>; </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</div><div class="line">    <span class="keyword">int</span> *p=<span class="keyword">new</span> (buf) <span class="keyword">int</span>(<span class="number">101</span>); </div><div class="line">    <span class="built_in">cout</span>&lt;&lt;*(<span class="keyword">int</span>*)buf&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-4-保证不抛出异常的new-运算符"><a href="#2-4-保证不抛出异常的new-运算符" class="headerlink" title="2.4 保证不抛出异常的new 运算符"></a>2.4 保证不抛出异常的new 运算符</h3><p>在分配内存失败时，new运算符的标准行为是抛出std::bad_alloc异常。也可以让new运算符在分配内存失败时不抛出异常而是返回空指针。其中<code>nothrow</code>是<code>std::nothrow_t</code>的一个实例.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">p = new (nothrow) type(init);</div><div class="line">p = new (nothrow) type[size];</div></pre></td></tr></table></figure>
<h3 id="2-5-自行定制参数的new运算符表达式"><a href="#2-5-自行定制参数的new运算符表达式" class="headerlink" title="2.5 自行定制参数的new运算符表达式"></a>2.5 自行定制参数的new运算符表达式</h3><p>new运算符的参数可以是任意合法类型的列表。由C++的重载机制来决定调用那个operator new。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> (Type_list) Type ( init );</div><div class="line"><span class="keyword">new</span> (Type_list) Type[size];</div></pre></td></tr></table></figure></p>
<h3 id="2-6-带位置的delete运算符"><a href="#2-6-带位置的delete运算符" class="headerlink" title="2.6 带位置的delete运算符"></a>2.6 带位置的delete运算符</h3><p>C++ 不能使用带位置的 delete 运算符表达式直接析构一个对象但不释放其内存。因此，对于用广义的带位置new表达式构建的对象，析构释放时有两种办法：</p>
<p>第一种办法是直接写一个函数，完成析构对象、释放内存的操作 。</p>
<h2 id="3-operator-new-函数重载"><a href="#3-operator-new-函数重载" class="headerlink" title="3.operator new() 函数重载"></a>3.operator new() 函数重载</h2><h3 id="3-1普通的operator-new-size-t-size-函数"><a href="#3-1普通的operator-new-size-t-size-函数" class="headerlink" title="3.1普通的operator new(size_t size)函数"></a>3.1普通的operator new(size_t size)函数</h3><p>operator new函数可以被每个C++类作为成员函数重载。也可以作为全局函数重载。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> * <span class="keyword">operator</span> <span class="title">new</span> <span class="params">(<span class="built_in">std</span>::<span class="keyword">size_t</span>)</span> <span class="title">throw</span><span class="params">(<span class="built_in">std</span>::bad_alloc)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="keyword">void</span>*)</span> <span class="title">throw</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure>
<p>内存需要回收的话,调用对应的operator delete()函数。</p>
<p>例如，在new运算符表达式的第二步，调用构造函数初始化内存时如果抛出异常，异常处理机制在栈展开（stack unwinding）时，要回收在new运算符表达式的第一步已经动态分配到的内存，这时就会自动调用对应operator delete()函数。</p>
<h3 id="3-2数组形式的operator-new-size-t-size-函数"><a href="#3-2数组形式的operator-new-size-t-size-函数" class="headerlink" title="3.2数组形式的operator new  [](size_t size)函数"></a>3.2数组形式的operator new  [](size_t size)函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">void * operator new[] (std::size_t) throw(std::bad_alloc); </div><div class="line">void operator delete[](void*) throw();</div></pre></td></tr></table></figure>
<h3 id="3-3-带位置的operator-new函数void-operator-new-size-t-void"><a href="#3-3-带位置的operator-new函数void-operator-new-size-t-void" class="headerlink" title="3.3 带位置的operator new函数void operator new(size_t,void)"></a>3.3 带位置的operator new函数void<em> operator new(size_t,void</em>)</h3><p><code>operator new(size_t,void*)</code>函数用于带位置的new运算符调用。C++标准库已经提供了operator new(size_t,void*)函数的实现，包含<code>&lt;new&gt;</code>头文件即可。这个实现只是简单的把参数的指定的地址返回，带位置的new运算符就会在该地址上调用构造函数来初始化对象。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Default placement versions of operator new. </span></div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="built_in">std</span>::<span class="keyword">size_t</span>, <span class="keyword">void</span>* __p)</span> <span class="title">throw</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> __p; &#125; </div><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span>* <span class="keyword">operator</span> <span class="keyword">new</span>[](<span class="built_in">std</span>::<span class="keyword">size_t</span>, <span class="keyword">void</span>* __p) <span class="keyword">throw</span>() &#123; <span class="keyword">return</span> __p; &#125; </div><div class="line"><span class="comment">// Default placement versions of operator delete. </span></div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span>  <span class="keyword">operator</span> <span class="title">delete</span>  <span class="params">(<span class="keyword">void</span>*, <span class="keyword">void</span>*)</span> <span class="title">throw</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span>  <span class="keyword">operator</span> <span class="keyword">delete</span>[](<span class="keyword">void</span>*, <span class="keyword">void</span>*) <span class="keyword">throw</span>() &#123; &#125;</div></pre></td></tr></table></figure>
<p>禁止重定义这4个函数。因为都已经作为<code>&lt;new&gt;</code>的内联函数了。在使用时，实际上不需要<code>#include &lt;new&gt;</code></p>
<p>对应的placement delete函数，只应在placement new运算符表达式在第二步调用构造函数抛出异常时被异常处理机制的栈展开操作自动调用。</p>
<h3 id="3-5保证不抛出异常的operator-new函数"><a href="#3-5保证不抛出异常的operator-new函数" class="headerlink" title="3.5保证不抛出异常的operator new函数"></a>3.5保证不抛出异常的operator new函数</h3><p>C++标准库的<code>&lt;new&gt;</code>中还提供了一个nothrow的实现，用户可写自己的函数替代：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="built_in">std</span>::<span class="keyword">size_t</span>, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="keyword">nothrow_t</span>&amp;)</span> <span class="title">throw</span><span class="params">()</span></span>; </div><div class="line"><span class="keyword">void</span>* <span class="keyword">operator</span> <span class="keyword">new</span>[](<span class="built_in">std</span>::<span class="keyword">size_t</span>, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="keyword">nothrow_t</span>&amp;) <span class="keyword">throw</span>(); </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="keyword">void</span>*, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="keyword">nothrow_t</span>&amp;)</span> <span class="title">throw</span><span class="params">()</span></span>; </div><div class="line"><span class="keyword">void</span> <span class="keyword">operator</span> <span class="keyword">delete</span>[](<span class="keyword">void</span>*, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="keyword">nothrow_t</span>&amp;) <span class="keyword">throw</span>();</div></pre></td></tr></table></figure>
<h3 id="3-6自行定制参数的operator-new函数"><a href="#3-6自行定制参数的operator-new函数" class="headerlink" title="3.6自行定制参数的operator new函数"></a>3.6自行定制参数的operator new函数</h3><p>这种函数被自行定制参数的new算符调用。需要由用户自行定义，以确定分配内存时的行为.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">operator</span> <span class="title">new</span><span class="params">(size_,Type1, Type2, ... )</span></span>;</div></pre></td></tr></table></figure>
<p>eg:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> data[<span class="number">1000</span>][<span class="keyword">sizeof</span>(<span class="keyword">int</span>)]; </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span> ,<span class="keyword">int</span> n)</span> </span>;&#123;        </div><div class="line">    <span class="keyword">return</span> data[n]; </div><div class="line">&#125; </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;    </div><div class="line">    <span class="keyword">int</span> *p=<span class="keyword">new</span>(<span class="number">6</span>) <span class="keyword">int</span>(<span class="number">102</span>); <span class="comment">//把整型对象创建在data的第六个单元上 </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="" />
          <p class="site-author-name" itemprop="name"></p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">5</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/huangyukun2012" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/guiling" target="_blank">
                  
                    <i class="fa fa-globe"></i> Zhihu
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

本站总访问量 <span id="busuanzi_value_site_pv"></span> &nbsp&nbsp&nbsp
您是第<span id="busuanzi_value_site_uv"></span>个来到的小伙伴


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=0.5.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"yukun2012"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  


</body>
</html>
